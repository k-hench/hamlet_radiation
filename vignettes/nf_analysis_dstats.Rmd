---
output: html_document
editor_options:
  chunk_output_type: console
css: highlight.css
---

```{r setup, include = FALSE}
knitr::knit_hooks$set(source = function(x, options) {
  if (!is.null(options$hilang)) {
      code_open <- "\n\n<div class=\"sourceCode\">\n<pre class=\"sourceCode\">\n<code class=\"sourceCode\">"
      code_close <- "\n</code>\n</pre>\n</div>\n"
      code_body <- highr::hi_andre(x, language = options$hilang, format = "html")
    stringr::str_c(
      code_open,
      knitr:::indent_block(paste(code_body, collapse = '\n'), ""),
      code_close
    )
  } else {
    stringr::str_c("\n\n```", tolower(options$engine), "\n",
                   paste(x, collapse = '\n'), "\n```\n\n")

  }
})
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../')
```


```{r, include = FALSE}
source('R/draw_workflow.R')
prod_basic <- tibbler(c('gxp_lm_smoothing_output, gxp_lmm_smoothing_output', 'gemma_results',
                        'phenotype_file', 'fst_glob', "fst_10k_output","fst_50k", 'fst_logs',
                        'multi_fst_output', 'fst_outlier_output','vcf_multi_fst'))
```

# (git 17) Analysis XV (dstats)

This pipeline can be executed as follows:

```sh
cd $BASE_DIR/nf/17_analysis_dstats
nextflow run analysis_dstats.nf -c ../../nextflow.config -resume
```

## Summary

The <span style="color:red;">...</span> are computed within the [**nextflow**](https://www.nextflow.io/) script `analysis_dstats.nf` (located under `$BASE_DIR/nf/17_analysis_dstats/`).
It takes the <span style="color:red;">...</span> and computes <span style="color:red;">...</span>.
Below is an overview of the steps involved in the analysis.

## Details of `analysis_dstats.nf`

### Setup

The nextflow script starts by <span style="color:red;">...</span>

:::kclass
```{r , eval = FALSE, hilang = 'nf'}
#!/usr/bin/env nextflow

// ----------------------- DISCLAIMER ----------------------
// this pipeline was not actually run using nextflow,
// but managed manually
// ---------------------------------------------------------

// git 17.1
// load genotypes
Channel
	.fromFilePairs("../../1_genotyping/4_phased/phased_mac2.vcf.{gz,gz.tbi}")
	.set{ genotypes_ch }
```


```{r , eval = FALSE, hilang = 'nf'}
// git 17.2
// drop serranus
process drop_serranus {
	
	input:
	set vcfId, file( vcf ) from genotypes_ch

	output:
	file( "hyp_mac2.vcf.gz" ) into no_serranus_ch

	script:
	"""
	vcfsamplenames ${vcf[0]} | \
		grep "tor\\|tab\\" > serr.pop

	vcftools --gzvcf ${vcf[0]} \
		--remove serr.pop \
		--recode \
		--stdout | bgzip > hyp_mac2.vcf.gz
	"""
}
```


```{r , eval = FALSE, hilang = 'nf'}
// git 17.4
// LD filtering
process ld_filter {
	
	input:
	file( vcf ) from no_serranus_ch

	output:
	file( "hyp_mac2_ld05.vcf.gz" ) into ld_filtered_ch

	script:
	"""
	bcftools +prune \
		-l 0.5 \
		-w 50kb \
		${vcf} \
		-Oz \
		-o hyp_mac2_ld05.vcf.gz
	"""
}
```


```{r , eval = FALSE, hilang = 'nf'}
// git 17.5
// run D trios
Channel
	.fromPath("../../ressources/hyp_sets.txt")
	.set{ hyp_sets_ch }
```


```{r , eval = FALSE, hilang = 'nf'}
// git 17.6
// run D trios
process run_dtrios {
	publishDir "../../2_analysis/dstats/", mode: 'copy'

	input:
	set file( vcf ), file( sets ) from ld_filtered_ch.combine( hyp_sets_ch )

	output:
	set file( "hyp_ld05_dtrios_BBAA.txt" ), file( "hyp_ld05_dtrios_Dmin.txt" ) into dtrios_results_ch

	script:
	"""
	zcat ${vcf} > hyp_mac2_ld05.vcf

	Dsuite Dtrios \
		-c \
		-o hyp_ld05_dtrios \
		hyp_mac2_ld05.vcf \
		${sets}
	"""
}
```


```{r , eval = FALSE, hilang = 'nf'}
// git 17.7
// load predefined species order
Channel
	.fromPath("../../ressources/species_order_alpha.txt")
	.set{ spec_order_ch }
```


```{r , eval = FALSE, hilang = 'nf'}
// git 17.8
// Extract significant Dmin, BBAA trios
process run_correction {
	publishDir "../../2_analysis/dstats/", mode: 'copy'

	input:
	set file( vcf ), file( sets ), file( spec_order) from dtrios_results_ch.combine( spec_order_ch )

	output:
	set file( "BBAA_sign_ld05.csv" ), file( "Dmin_sign_ld05.csv" ) into dtrios_signif_ch

	script:
	"""
	Rscript --vanilla \$BASE_DIR/R/dstats.R
	"""
}
```
:::

---
