---
output: html_document
editor_options:
  chunk_output_type: console
---
# Supplementary Figure 6

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../')
library(GenomicOriginsScripts)
library(vroom)
library(hypoimg)
args <- c('2_analysis/pi/50k/',
          '2_analysis/fasteprr/step4/fasteprr.all.rho.txt.gz')
```

## Summary

This is the accessory documentation of Supplementary Figure 6.
The Figure can be recreated by running the **R** script `plot_SF6.R`:

```sh
cd $BASE_DIR

Rscript --vanilla R/fig/plot_SF6.R 2_analysis/pi/50k/ \
  2_analysis/fasteprr/step4/fasteprr.all.rho.txt.gz

```

## Details of `plot_SF6.R`

In the following, the individual steps of the R script are documented.
It is an executable R script that depends on the accessory R package [**GenomicOriginsScripts**](https://k-hench.github.io/GenomicOriginsScripts) as well as the packages [**hypoimg**](https://k-hench.github.io/hypoimg) and [**vroom**](https://vroom.r-lib.org/).

### Config

The scripts start with a header that contains copy & paste templates to execute or debug the script:

```{r, message = FALSE, warning = FALSE}
#!/usr/bin/env Rscript
# run from terminal:
# Rscript --vanilla R/fig/plot_SF6.R \
#   2_analysis/summaries/fst_globals.txt \
#   2_analysis/fst/50k/ \
#   2_analysis/fasteprr/step4/fasteprr.all.rho.txt.gz
# ===============================================================
# This script produces Suppl. Figure 6 of the study "Ancestral variation,
# hybridization and modularity fuel a marine radiation"
# by Hench, Helmkampf, McMillan and Puebla
# ---------------------------------------------------------------
# ===============================================================
# args <- c( '2_analysis/summaries/fst_globals.txt',
#            '2_analysis/fst/50k/',
#            '2_analysis/fasteprr/step4/fasteprr.all.rho.txt.gz')
# script_name <- "R/fig/plot_SF6.R"
```

The next section processes the input from the command line.
It stores the arguments in the vector `args`.
The needed R packages are loaded and the script name and the current working directory are stored inside variables (`script_name`, `plot_comment`).
This information will later be written into the meta data of the figure to help us tracing back the scripts that created the figures in the future.

Then we drop all the imported information besides the arguments following the script name and print the information to the terminal.

```{r, eval = FALSE}
args <- commandArgs(trailingOnly = FALSE)
# setup -----------------------
library(GenomicOriginsScripts)
library(hypoimg)
library(hypogen)
library(vroom)
library(furrr)
library(ggtext)
cat('\n')
script_name <- args[5] %>%
  str_remove(.,'--file=')

plot_comment <- script_name %>%
  str_c('mother-script = ',getwd(),'/',.)

cli::rule( left = str_c(crayon::bold('Script: '),crayon::red(script_name)))
args = args[7:length(args)]
cat(' ')
cat(str_c(crayon::green(cli::symbol$star),' ', 1:length(args),': ',crayon::green(args),'\n'))
cli::rule(right = getwd())
```

```r
#> ── Script: scripts/plot_SF6.R ────────────────────────────────────────────
#> Parameters read:
#> ★ 1: 2_analysis/pi/50k/
#> ★ 2: 2_analysis/fasteprr/step4/fasteprr.all.rho.txt.gz
#> ─────────────────────────────────────────── /current/working/directory ──
```

The paths containing the $\pi$ and $\rho$ data are received and stored inside more descriptive variables.

```{r, message = FALSE, warning = FALSE}
# config -----------------------
pi_path <- as.character(args[1])
rho_path <- as.character(args[2])
```

The $\pi$-path is screened for data files in the desired resolution (50 kb windows).

```{r, message = FALSE, warning = FALSE}
# locate pi data files
files <- dir(pi_path, pattern = '^[a-z]{6}.50k')
```

Then, the $\pi$ data is loaded and compiled into a single table containing all populations.

```{r, message = FALSE, warning = FALSE}
# load pi data
data <- str_c(pi_path, files) %>%
  purrr::map(get_pi) %>%
  bind_rows()
```

To be able to order the subplots of the final figure by the genome wide average $\pi$ of the populations, we create a second dta table containing the summary of the $\pi$ data for all populations.

```{r, message = FALSE, warning = FALSE}
# compute genome wide average pi for the subplot order
global_bar <- data %>%
  filter( BIN_START %% 50000 == 1) %>%
  select(N_VARIANTS, PI, spec) %>%
  group_by(spec) %>%
  summarise(genome_wide_pi = sum(N_VARIANTS*PI)/sum(N_VARIANTS)) %>%
  arrange(genome_wide_pi) %>%
  ungroup() %>%
  mutate(spec = fct_reorder(.f = spec, .x = genome_wide_pi),
         scaled_pi = genome_wide_pi/max(genome_wide_pi))
```

Then, we load the $\rho$ data.

```{r, message = FALSE, warning = FALSE}
# load recombination data
rho_data <- vroom(rho_path, delim = '\t') %>%
  select(-BIN_END)
```

To be able to regress $\pi$ on $\rho$ the two data sets are merged based on the window position on the hamlet reference genome.

```{r, message = FALSE, warning = FALSE}
# merge pi and recombination data
combined_data <- data %>%
  # filter pi data to "non-overlapping" windows
  filter(BIN_START %% 50000 == 1 ) %>%
  # reorder populations by genome wide average pi
  mutate(spec = factor(spec, levels = levels(global_bar$spec))) %>%
  # merge with recombination data
  left_join(rho_data, by = c(CHROM = 'CHROM', BIN_START = 'BIN_START'))
```

Then the data set is nested and for each hamlet population a linear regression of the dependence of $\pi$ on $\rho$ is modeled.
Then the model statistics are stored in additionnal columns.

```{r, message = FALSE, warning = FALSE}
# nest data to run linear regression on all runs in one go
model_data <- combined_data %>%
  group_by(spec) %>%
  nest() %>%
  left_join(., global_bar) %>%
  mutate(mod =  map(data, ~ lm(.$PI ~ .$RHO))) %>%
  bind_cols(., summarise_model(.))
```

To indicate the hamlet population on the sub-plots, hamlet illustrations are loaded.

```{r, message = FALSE, warning = FALSE}
# create table with fish annotations
grob_tibble2 <- global_bar$spec %>%
  purrr::map(fish_plot2) %>%
  bind_rows()
```

Then, the final figure is created.

```{r, message = FALSE, warning = FALSE}
# compose final figure
p <- combined_data %>%
  ggplot()+
  # add fish annotations
  geom_hypo_grob2(data = grob_tibble2,
                  aes(grob = grob, rel_x = .25,rel_y = .75),
                  angle = 0, height = .5,width = .5)+
  # add hex-bin desity layer
  geom_hex(bins = 30,color = rgb(0,0,0,.3),
           aes(fill=log10(..count..), x = RHO, y = PI))+
 # general plot structure (separated by run)
  facet_wrap(spec ~., ncol = 3)+
  # set axis layout and color scheme
  scale_x_continuous(name = expression(rho))+
  scale_y_continuous(name = expression(pi))+
  scico::scale_fill_scico(palette = 'berlin') +
  # customize legend
  guides(fill = guide_colorbar(direction = 'horizontal',
                               title.position = 'top',
                               barheight = unit(7,'pt'),
                               barwidth = unit(130,'pt')))+
  # general plot layout
  theme_minimal()+
  theme(legend.position = c(.84,.01),
        strip.text = element_blank())
```

<center>
```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.width = 8, fig.height = 12, dev.args = list(type = "cairo")}
p
```
</center>

Finally, we can export Supplementary Figure 6.

```{r, eval = FALSE}
# export final figure
hypo_save(filename = 'figures/SF6.pdf',
          plot = p,
          width = 8,
          height = 10,
          comment = plot_comment)

```

---
